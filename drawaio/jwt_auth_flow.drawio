<mxfile host="app.diagrams.net" modified="2024-01-19T00:00:00.000Z" agent="5.0" version="22.1.16">
  <diagram name="JWT Authentication Flow" id="jwt-auth-flow">
    <mxGraphModel dx="1434" dy="844" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="2000" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="JWT ì¸ì¦ íë¦„ (ë¡œê·¸ì¸ ìœ ì§€ + IP ê²€ì¦ + Token Rotation)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=18;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="234.5" y="40" width="700" height="40" as="geometry" />
        </mxCell>

        <!-- Actors -->
        <mxCell id="user" value="ì‚¬ìš©ìž" style="shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="80" y="120" width="40" height="80" as="geometry" />
        </mxCell>

        <mxCell id="frontend" value="í”„ë¡ íŠ¸ì—”ë“œ&lt;br&gt;(Next.js/Flutter)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="200" y="130" width="120" height="60" as="geometry" />
        </mxCell>

        <mxCell id="api-server" value="API ì„œë²„&lt;br&gt;(Java Backend)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="440" y="130" width="120" height="60" as="geometry" />
        </mxCell>

        <mxCell id="database" value="ë°ì´í„°ë² ì´ìŠ¤&lt;br&gt;(Token ì €ìž¥)" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="680" y="120" width="120" height="80" as="geometry" />
        </mxCell>

        <!-- Phase 1: Login -->
        <mxCell id="phase1-title" value="Phase 1: ë¡œê·¸ì¸" style="text;html=1;strokeColor=#b85450;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="240" width="760" height="30" as="geometry" />
        </mxCell>

        <mxCell id="step1" value="1. ID/PW ìž…ë ¥ + ë¡œê·¸ì¸ ìœ ì§€ ì²´í¬" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="100" y="300" as="sourcePoint" />
            <mxPoint x="260" y="300" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step2" value="2. POST /api/auth/login&lt;br&gt;{id, password, rememberMe, clientIP}" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="260" y="330" as="sourcePoint" />
            <mxPoint x="500" y="330" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step3" value="3. ID/PW ê²€ì¦" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="440" y="360" width="120" height="40" as="geometry" />
        </mxCell>

        <mxCell id="step4" value="4. Token ìƒì„±&lt;br&gt;Access Token (30ë¶„)&lt;br&gt;Refresh Token&lt;br&gt;- rememberMe=true: 30ì¼&lt;br&gt;- rememberMe=false: 7ì¼" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="440" y="420" width="120" height="90" as="geometry" />
        </mxCell>

        <mxCell id="step5" value="5. DB ì €ìž¥&lt;br&gt;- userId&lt;br&gt;- refreshToken (ì•”í˜¸í™”)&lt;br&gt;- clientIP&lt;br&gt;- expiresAt (rememberMeì— ë”°ë¼)&lt;br&gt;- createdAt" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="560" y="465" as="sourcePoint" />
            <mxPoint x="740" y="465" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step6" value="6. ì‘ë‹µ â­&lt;br&gt;Header: Authorization: Bearer {accessToken}&lt;br&gt;Cookie: refreshToken (HttpOnly, Secure)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d6b656;fontSize=11;fontStyle=1" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="530" as="sourcePoint" />
            <mxPoint x="260" y="530" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step7" value="7. Access Token ë©”ëª¨ë¦¬ ì €ìž¥&lt;br&gt;(State/Vuex/Redux)&lt;br&gt;Refresh Tokenì€ Cookieì— ìžë™ ì €ìž¥" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="200" y="560" width="120" height="70" as="geometry" />
        </mxCell>

        <!-- Phase 2: Auto Login (Keep Me Logged In) -->
        <mxCell id="phase2-title" value="Phase 2: ë¡œê·¸ì¸ ìœ ì§€ (ë¸Œë¼ìš°ì € ìž¬ì‹œìž‘ ì‹œ)" style="text;html=1;strokeColor=#d6b656;fillColor=#fff2cc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="670" width="760" height="30" as="geometry" />
        </mxCell>

        <mxCell id="step8" value="8. ì‚¬ìš©ìžê°€ ë¸Œë¼ìš°ì € ë‹«ìŒ&lt;br&gt;ë©”ëª¨ë¦¬ Access Token ì‚¬ë¼ì§" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="200" y="720" width="120" height="60" as="geometry" />
        </mxCell>

        <mxCell id="step9" value="9. ë¸Œë¼ìš°ì € ë‹¤ì‹œ ì—´ê³  ì‚¬ì´íŠ¸ ì ‘ì†" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="100" y="810" as="sourcePoint" />
            <mxPoint x="260" y="810" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step10" value="10. useEffect ì‹¤í–‰&lt;br&gt;Access Token ì—†ìŒ ê°ì§€&lt;br&gt;ìžë™ ê°±ì‹  ì‹œë„" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="200" y="830" width="120" height="70" as="geometry" />
        </mxCell>

        <mxCell id="step11" value="11. POST /api/auth/refresh&lt;br&gt;Cookie: refreshToken (ìžë™ ì „ì†¡)&lt;br&gt;Header: X-Client-IP" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="260" y="920" as="sourcePoint" />
            <mxPoint x="500" y="920" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step12" value="12. DBì—ì„œ Refresh Token ì¡°íšŒ" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="560" y="950" as="sourcePoint" />
            <mxPoint x="740" y="950" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step13" value="13. ê²€ì¦&lt;br&gt;- Token ì¼ì¹˜ ì—¬ë¶€&lt;br&gt;- ë§Œë£Œì‹œê°„ í™•ì¸&lt;br&gt;- IP ê²€ì¦ (ì„ íƒ)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="440" y="980" width="120" height="70" as="geometry" />
        </mxCell>

        <mxCell id="step14" value="14. ìƒˆë¡œìš´ Token ìƒì„±&lt;br&gt;- ìƒˆ Access Token (30ë¶„)&lt;br&gt;- ìƒˆ Refresh Token (Rotation)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="440" y="1070" width="120" height="70" as="geometry" />
        </mxCell>

        <mxCell id="step15" value="15. DB ì—…ë°ì´íŠ¸&lt;br&gt;- ìƒˆ Refresh Token ì €ìž¥&lt;br&gt;- ê¸°ì¡´ Token ë¬´íš¨í™”" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="560" y="1105" as="sourcePoint" />
            <mxPoint x="740" y="1105" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step16" value="16. ì‘ë‹µ â­&lt;br&gt;Header: Authorization: Bearer {accessToken}&lt;br&gt;Cookie: refreshToken (ìƒˆë¡œìš´)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d6b656;fontSize=11;fontStyle=1" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="1160" as="sourcePoint" />
            <mxPoint x="260" y="1160" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step17" value="17. Access Token Stateì— ì €ìž¥&lt;br&gt;âœ… ë¡œê·¸ì¸ ìœ ì§€ ì„±ê³µ!" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="200" y="1190" width="120" height="60" as="geometry" />
        </mxCell>

        <!-- Phase 3: API Request -->
        <mxCell id="phase3-title" value="Phase 3: API ìš”ì²­ (Access Token ì‚¬ìš©)" style="text;html=1;strokeColor=#6c8ebf;fillColor=#dae8fc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="1290" width="760" height="30" as="geometry" />
        </mxCell>

        <mxCell id="step18" value="18. GET /api/resource&lt;br&gt;Header: Authorization: Bearer {accessToken}" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="260" y="1350" as="sourcePoint" />
            <mxPoint x="500" y="1350" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step19" value="19. Access Token ê²€ì¦&lt;br&gt;- ì„œëª… ê²€ì¦&lt;br&gt;- ë§Œë£Œì‹œê°„ í™•ì¸" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="440" y="1380" width="120" height="60" as="geometry" />
        </mxCell>

        <mxCell id="step20" value="20. ë¦¬ì†ŒìŠ¤ ë°˜í™˜" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="1460" as="sourcePoint" />
            <mxPoint x="260" y="1460" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Phase 4: Token Refresh (when expired) -->
        <mxCell id="phase4-title" value="Phase 4: Access Token ë§Œë£Œ ì‹œ ê°±ì‹ " style="text;html=1;strokeColor=#b85450;fillColor=#f8cecc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="1510" width="760" height="30" as="geometry" />
        </mxCell>

        <mxCell id="step21" value="21. API ìš”ì²­ ì‹œ 401 Unauthorized" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#b85450;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="1570" as="sourcePoint" />
            <mxPoint x="260" y="1570" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step22" value="22. Interceptorê°€ ê°ì§€&lt;br&gt;ìžë™ ê°±ì‹  ì‹œë„" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="200" y="1600" width="120" height="60" as="geometry" />
        </mxCell>

        <mxCell id="step23" value="23. POST /api/auth/refresh&lt;br&gt;Cookie: refreshToken (ìžë™ ì „ì†¡)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="260" y="1680" as="sourcePoint" />
            <mxPoint x="500" y="1680" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step24" value="24. ê²€ì¦ + ìƒˆ Token ë°œê¸‰ + DB ê°±ì‹ &lt;br&gt;(Phase 2ì™€ ë™ì¼)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="440" y="1710" width="120" height="60" as="geometry" />
        </mxCell>

        <mxCell id="step25" value="25. ìƒˆ Token ì‘ë‹µ&lt;br&gt;Header: Authorization: Bearer {newToken}&lt;br&gt;Cookie: refreshToken (ìƒˆë¡œìš´)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d6b656;fontSize=11;fontStyle=1" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="500" y="1790" as="sourcePoint" />
            <mxPoint x="260" y="1790" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step26" value="26. ì›ëž˜ API ìž¬ìš”ì²­" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;fontSize=11;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="260" y="1830" as="sourcePoint" />
            <mxPoint x="500" y="1830" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Frontend Code Example -->
        <mxCell id="code-title" value="ðŸ’» í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ì˜ˆì‹œ (Next.js)" style="text;html=1;strokeColor=#9673a6;fillColor=#e1d5e7;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="1890" width="760" height="30" as="geometry" />
        </mxCell>

        <mxCell id="code-example" value="// 1. ë¡œê·¸ì¸&#xa;const handleLogin = async (id, password, rememberMe) => {&#xa;  const response = await fetch('/api/auth/login', {&#xa;    method: 'POST',&#xa;    credentials: 'include', // Cookie ì „ì†¡&#xa;    body: JSON.stringify({ id, password, rememberMe })&#xa;  });&#xa;  const accessToken = response.headers.get('Authorization'); â­&#xa;  setAccessToken(accessToken); // Stateì— ì €ìž¥&#xa;};&#xa;&#xa;// 2. íŽ˜ì´ì§€ ë¡œë“œ ì‹œ ìžë™ ë¡œê·¸ì¸ ìœ ì§€&#xa;useEffect(() => {&#xa;  const initAuth = async () => {&#xa;    if (!accessToken) {&#xa;      try {&#xa;        const response = await fetch('/api/auth/refresh', {&#xa;          method: 'POST',&#xa;          credentials: 'include' // Refresh Token ìžë™ ì „ì†¡&#xa;        });&#xa;        if (response.ok) {&#xa;          const newToken = response.headers.get('Authorization'); â­&#xa;          setAccessToken(newToken);&#xa;        } else {&#xa;          router.push('/login');&#xa;        }&#xa;      } catch (error) {&#xa;        router.push('/login');&#xa;      }&#xa;    }&#xa;  };&#xa;  initAuth();&#xa;}, []);&#xa;&#xa;// 3. API ìš”ì²­ ì‹œ Interceptor&#xa;axios.interceptors.response.use(&#xa;  response => response,&#xa;  async error => {&#xa;    if (error.response?.status === 401) {&#xa;      const refreshResponse = await fetch('/api/auth/refresh', {&#xa;        method: 'POST',&#xa;        credentials: 'include'&#xa;      });&#xa;      const newToken = refreshResponse.headers.get('Authorization'); â­&#xa;      setAccessToken(newToken);&#xa;      error.config.headers['Authorization'] = newToken;&#xa;      return axios.request(error.config);&#xa;    }&#xa;    return Promise.reject(error);&#xa;  }&#xa;);" style="text;html=1;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontColor=#333333;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="40" y="1930" width="760" height="520" as="geometry" />
        </mxCell>

        <!-- Backend Code Example -->
        <mxCell id="backend-title" value="â˜• ë°±ì—”ë“œ ì½”ë“œ ì˜ˆì‹œ (Java Spring)" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="2470" width="760" height="30" as="geometry" />
        </mxCell>

        <mxCell id="backend-example" value="@PostMapping(&quot;/api/auth/login&quot;)&#xa;public ResponseEntity&lt;?&gt; login(@RequestBody LoginRequest request, HttpServletResponse response) {&#xa;    // 1. ID/PW ê²€ì¦&#xa;    User user = userService.authenticate(request.getId(), request.getPassword());&#xa;    &#xa;    // 2. Token ìƒì„±&#xa;    String accessToken = jwtService.generateAccessToken(user.getId());&#xa;    &#xa;    int refreshTokenExpiry = request.isRememberMe() ? 30 * 24 * 60 * 60 : 7 * 24 * 60 * 60;&#xa;    String refreshToken = jwtService.generateRefreshToken(user.getId(), refreshTokenExpiry);&#xa;    &#xa;    // 3. DB ì €ìž¥&#xa;    tokenRepository.save(new RefreshToken(&#xa;        user.getId(), &#xa;        encryptToken(refreshToken), &#xa;        request.getClientIP(),&#xa;        LocalDateTime.now().plusSeconds(refreshTokenExpiry)&#xa;    ));&#xa;    &#xa;    // 4. â­ Headerë¡œ Access Token ë°˜í™˜&#xa;    response.setHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);&#xa;    &#xa;    // 5. Cookieë¡œ Refresh Token ë°˜í™˜&#xa;    Cookie refreshCookie = new Cookie(&quot;refreshToken&quot;, refreshToken);&#xa;    refreshCookie.setHttpOnly(true);&#xa;    refreshCookie.setSecure(true);&#xa;    refreshCookie.setPath(&quot;/api/auth/refresh&quot;);&#xa;    refreshCookie.setMaxAge(refreshTokenExpiry);&#xa;    response.addCookie(refreshCookie);&#xa;    &#xa;    return ResponseEntity.ok().body(Map.of(&quot;message&quot;, &quot;ë¡œê·¸ì¸ ì„±ê³µ&quot;));&#xa;}&#xa;&#xa;@PostMapping(&quot;/api/auth/refresh&quot;)&#xa;public ResponseEntity&lt;?&gt; refresh(&#xa;    @CookieValue(&quot;refreshToken&quot;) String refreshToken,&#xa;    @RequestHeader(&quot;X-Client-IP&quot;) String clientIP,&#xa;    HttpServletResponse response&#xa;) {&#xa;    // 1. DB ì¡°íšŒ ë° ê²€ì¦&#xa;    RefreshToken storedToken = tokenRepository.findByToken(encryptToken(refreshToken))&#xa;        .orElseThrow(() -&gt; new UnauthorizedException(&quot;Invalid token&quot;));&#xa;    &#xa;    if (storedToken.isExpired()) {&#xa;        throw new UnauthorizedException(&quot;Token expired&quot;);&#xa;    }&#xa;    &#xa;    // 2. IP ê²€ì¦ (ì„ íƒ)&#xa;    if (!storedToken.getClientIP().equals(clientIP)) {&#xa;        throw new SecurityException(&quot;IP mismatch&quot;);&#xa;    }&#xa;    &#xa;    // 3. ìƒˆ Token ìƒì„± (Rotation)&#xa;    String newAccessToken = jwtService.generateAccessToken(storedToken.getUserId());&#xa;    String newRefreshToken = jwtService.generateRefreshToken(storedToken.getUserId());&#xa;    &#xa;    // 4. DB ì—…ë°ì´íŠ¸&#xa;    storedToken.updateToken(encryptToken(newRefreshToken));&#xa;    tokenRepository.save(storedToken);&#xa;    &#xa;    // 5. â­ Headerë¡œ ìƒˆ Access Token ë°˜í™˜&#xa;    response.setHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + newAccessToken);&#xa;    &#xa;    // 6. Cookieë¡œ ìƒˆ Refresh Token ë°˜í™˜&#xa;    Cookie newRefreshCookie = new Cookie(&quot;refreshToken&quot;, newRefreshToken);&#xa;    newRefreshCookie.setHttpOnly(true);&#xa;    newRefreshCookie.setSecure(true);&#xa;    newRefreshCookie.setPath(&quot;/api/auth/refresh&quot;);&#xa;    newRefreshCookie.setMaxAge(storedToken.getRemainingSeconds());&#xa;    response.addCookie(newRefreshCookie);&#xa;    &#xa;    return ResponseEntity.ok().body(Map.of(&quot;message&quot;, &quot;í† í° ê°±ì‹  ì„±ê³µ&quot;));&#xa;}" style="text;html=1;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontColor=#333333;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="40" y="2510" width="760" height="700" as="geometry" />
        </mxCell>

        <!-- Security Notes -->
        <mxCell id="security-title" value="ðŸ›¡ï¸ ë³´ì•ˆ ì‚¬í•­" style="text;html=1;strokeColor=#82b366;fillColor=#d5e8d4;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="3230" width="760" height="30" as="geometry" />
        </mxCell>

        <mxCell id="security-notes" value="1. Access Token: Response Headerë¡œ ë°˜í™˜ (Authorization í—¤ë”) â­&#xa;2. Refresh Token: HttpOnly Cookieë¡œ ë°˜í™˜ (XSS ë°©ì§€)&#xa;3. Access Token ë§Œë£Œ: 30ë¶„ (ì§§ì€ ìˆ˜ëª…ìœ¼ë¡œ íƒˆì·¨ ìœ„í—˜ ê°ì†Œ)&#xa;4. Refresh Token ë§Œë£Œ: ë¡œê·¸ì¸ ìœ ì§€ ì²´í¬ ì‹œ 30ì¼, ë¯¸ì²´í¬ ì‹œ 7ì¼&#xa;5. Refresh Token Rotation: ì‚¬ìš© ì‹œë§ˆë‹¤ ìƒˆë¡œìš´ í† í° ë°œê¸‰ ë° ê¸°ì¡´ í† í° ë¬´íš¨í™”&#xa;6. IP ê²€ì¦: í† í° ë°œê¸‰ ì‹œ IP ì €ìž¥, ì‚¬ìš© ì‹œ ë¹„êµ (ì„ íƒì‚¬í•­)&#xa;7. HTTPS í•„ìˆ˜: ëª¨ë“  í†µì‹  ì•”í˜¸í™”&#xa;8. DB ì €ìž¥: Refresh Token ì•”í˜¸í™”í•˜ì—¬ ì €ìž¥&#xa;9. SameSite=Strict: CSRF ê³µê²© ë°©ì§€&#xa;10. ë¡œê·¸ì¸ ìœ ì§€: Refresh Tokenì´ Cookieì— ì‚´ì•„ìžˆëŠ” ë™ì•ˆ ìžë™ ë¡œê·¸ì¸" style="text;html=1;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=11;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="40" y="3270" width="760" height="160" as="geometry" />
        </mxCell>

        <!-- DB Schema -->
        <mxCell id="db-title" value="ðŸ“Š DB ìŠ¤í‚¤ë§ˆ (refresh_tokens í…Œì´ë¸”)" style="text;html=1;strokeColor=#d6b656;fillColor=#fff2cc;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="40" y="3450" width="760" height="30" as="geometry" />
        </mxCell>

        <mxCell id="db-schema" value="CREATE TABLE refresh_tokens (&#xa;    id BIGINT AUTO_INCREMENT PRIMARY KEY,&#xa;    user_id BIGINT NOT NULL,&#xa;    refresh_token VARCHAR(500) NOT NULL UNIQUE,  -- ì•”í˜¸í™”ëœ í† í°&#xa;    client_ip VARCHAR(45),                       -- IPv6 ì§€ì›&#xa;    expires_at DATETIME NOT NULL,&#xa;    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,&#xa;    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,&#xa;    &#xa;    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,&#xa;    INDEX idx_user_id (user_id),&#xa;    INDEX idx_refresh_token (refresh_token),&#xa;    INDEX idx_expires_at (expires_at)&#xa;);" style="text;html=1;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontColor=#333333;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="40" y="3490" width="760" height="200" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>